<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <link href="data:image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAA////AN3V1QDo4+MA/4CAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADMiIiIiMwADNERERERDMAMkIiIiIkIwAyQyMjIyQjADJBMTExNCMAMkMTExMUIwAyQRERERQjADJBMTExNCMAMkEREREUIwAyQxMTIyQjADJBERRERDMAMkERFBFCMwAyQREUFCMzADJBERRCMzMAM0RERCMzMwADMiIjMzMwDAAwAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAIABAADAAwAA" rel="icon" type="image/x-icon">
<style type="text/css">

:root {
  --background-dark: hsl(231, 15%, 14%);
  --background: hsl(231, 15%, 18%);
  --background-light: hsl(231, 15%, 22%);
  --selection-dark: hsl(231, 14%, 26.5%);
  --selection: hsl(231, 14%, 31%);
  --selection-light: hsl(231, 14%, 35%);
  --foreground-dark: hsl(60, 6%, 64%);
  --foreground: hsl(60, 18%, 80%);
  --foreground-light: hsl(60, 30%, 96%);
  --comment: #6272a4;
  --cyan: #8be9fd;
  --green: #50fa7b;
  --orange: #ffb86c;
  --pink: #ff79c6;
  --purple: #bd93f9;
  --red: #ff5555;
  --yellow: #f1fa8c;
  --1: 3.7vw;
  --a: calc(var(--1) / 30);
  --b: calc(var(--1) / 20);
  --c: calc(var(--1) / 10);
  --d: calc(var(--1) / 5);
  --0: calc(var(--1) / 2);
  --2: calc(var(--1) * 2);
  --3: calc(var(--1) * 3);
  --4: calc(var(--1) * 4);
  --5: calc(var(--1) * 5);
  --6: calc(var(--1) * 6);
  --7: calc(var(--1) * 7);
  --8: calc(var(--1) * 8);
  --9: calc(var(--1) * 9);
  --10: calc(var(--1) * 10);
  --11: calc(var(--1) * 11);
  --12: calc(var(--1) * 12);
}

@media all and (min-width: 812px) {
  :root {
    --1: 32px;
  }
}

* {
  box-sizing: border-box;
  font-family: monospace;
  font-size: var(--0);
  background-color: inherit;
  color: inherit;
}

body {
  background-color: var(--background);
  color: var(--foreground);
  white-space: pre-wrap;
  overflow-x: hidden;
}

.message {
  display: inline-block;
  color: var(--comment);
  padding-left: 2ch;
}

#menu {
  text-align: center;
}

button {
  border: none;
  margin: 0;
}
a {
  text-decoration: none;
}
.on {
  color: var(--green);
}
.off {
  color: var(--pink)
}
</style>
  </head>
  <body style="opacity: 0.75">
<div id="menu"><button> draft</button><button> unassigned</button><button> assigned</button></div>
<div id="root"></div>
<script type="module">

const c = [
  'background-dark', 'background', 'background-light', 'selection-dark',
  'selection', 'selection-light', 'foreground-dark', 'foreground',
  'foreground-light', 'comment', 'cyan', 'green', 'orange', 'pink', 'purple',
  'red', 'yellow',
].reduce((acc, color) => {

  const on = `<span style="color:var(--${color})">`
  const f = text => `${on}${text}</span>`
  f.on = on

  return {...acc, [color.replace(/-(.)/, (_,a)=> a.toUpperCase())]: f }
}, { off: `</span>` })

const rand = () =>
  Math.random()
    .toString(36)
    .slice(2)

const query = `
query ($name: String!, $owner: String!) {
  repository(owner: $owner, name: $name) {
    pullRequests(first: 100, states: OPEN) {
      edges {
        node {
          number
          author { login }
          baseRepository { nameWithOwner }
          createdAt
          updatedAt
          additions
          deletions
          mergeable
          state
          title
          isDraft
          activeLockReason
          closed
          bodyText
          reviewRequests(first: 10) {
            nodes {
              requestedReviewer {
                ... on User {
                  login 
                }
              }
            }
          }
          assignees(first: 10) {
            nodes {
              ...on User {
                login
              }
            }
          }
        }
      }
    }
  }
}`

const getList = async (variables, token) => {
  const res = await fetch('https://api.github.com/graphql', {
    headers: {
      accept: 'application/vnd.github.shadow-cat-preview+json',
      'content-type': 'application/json',
      Authorization: `bearer ${token}`,
    },
    body: JSON.stringify({ query, variables }),
    method: 'POST',
    mode: 'cors',
  })
  const { data, errors } = await res.json()
  if (errors) {
    const err = Error(errors[0].message)
    err.type = errors[0].type
    err.line = errors[0].line
    err.column = errors[0].column
    throw err
  }
  const pulls = data.repository && data.repository.pullRequests
  return pulls && pulls.edges.map(e => e.node)
}

const getToken = async () => {
  const { searchParams } = new URL(window.location)
  window.history.replaceState('', '', window.location.pathname)
  const cachedToken = localStorage.token
  if (cachedToken) return cachedToken

  const paramState = searchParams.get('state')
  if (paramState && searchParams.has('code')) {
    if (paramState !== localStorage.state) {
      localStorage.removeItem('state')
      localStorage.removeItem('token')
      return getToken()
    }
    const res = await fetch(`https://pr.kigiri.now.sh/auth?${searchParams}`)
    const body = await res.text()
    const token = new URLSearchParams(body).get('access_token')
    return localStorage.token = token
  }

  const state = [rand(), rand(), rand()].join('-')
  localStorage.state = state

  // Request a user's GitHub identity
  const authorizationUrl = `https://github.com/login/oauth/authorize?${[
    // Required. The client ID you received from GitHub when you registered.
    `client_id=bc9a4b96852fb49c7cb9`,

    // The URL in your application where users will be sent after authorization.
    `redirect_uri=${encodeURIComponent(window.location)}`,

    // A random state
    `state=${state}`,

    // A space-delimited list of scopes.
    `scope=${encodeURIComponent(['user', 'repo', 'read:org'].join(' '))}`,
  ].join('&')}`

  // load the address
  window.location.replace(authorizationUrl)

  // return an unresolvable promise to pause
  return new Promise(() => {})
}

const X = c.red('x')
const O = c.green('o')
const TO = c.pink('â–¸')
const FROM = c.pink('FROM')
const mergeable = pr => {
  if (pr.isDraft) return c.comment('-')
  return pr.mergeable === 'MERGEABLE' ? O : X
}

const assign = pr => [...new Set([
  ...pr.assignees.nodes.map(n => n.login),
  ...pr.reviewRequests.nodes.map(n => n.requestedReviewer.login),
])].sort()

const assignees = pr => pr.to.length ? `${TO} ${pr.to.join(', ')}` : ''

const rtf = new Intl.RelativeTimeFormat('en', { numeric: 'auto' })
const units = Object.entries({
  second: 1000,
  minute: 60*1000,
  hour: 60*60*1000,
  day: 24*60*60*1000,
  week: 7*24*60*60*1000,
  month: 4*7*24*60*60*1000,
  quarter: 3*4*7*24*60*60*1000,
})

const fmtTime = time => {
  const diff = Date.now() - time
  let unit
  let value
  for (const [ nextUnit, nextValue ] of units) {
    if (diff < nextValue) {
      if (!unit) return 'just now'
      return rtf.format(-Math.floor(diff / value), unit)
    }
    unit = nextUnit
    value = nextValue
  }
  return rtf.format(-Math.floor(diff / 4*3*4*7*24*60*60*1000), 'year')
}
const empty = str => Boolean(str.trim())
const DASH = c.comment('-')
const generateHTML = pr => `<article ${[
  `data-draft=${pr.isDraft ? 'on' : 'off'}`,
  `data-unassigned=${!pr.to.length ? 'on' : 'off'}`,
  `data-assigned=${pr.to.includes(pr.user) ? 'on' : 'off'}`,
].join(' ')}>${[
  [
    mergeable(pr),
    [
      `<a href="https://github.com/${pr.baseRepository.nameWithOwner}/pull/${
        pr.number
      }/files?w=1">`,
      c.purple(pr.baseRepository.nameWithOwner),
      c.yellow(`#${pr.number}`),
      '</a>',
    ].join(''),
    `${pr.additions - pr.deletions} lines`,
    `(+${c.green(pr.additions)} -${c.red(pr.deletions)})`,
    `<time datetime="${pr.updatedAt}">${fmtTime(pr.updatedAt)}</time>`
  ].join(' '),
  `  ${c.cyan(pr.author.login)}: ${c.foregroundLight(pr.title)}`,
  `  ${assignees(pr)}`,
  pr.bodyText && `<div class="message">${pr.bodyText}</div>`,
]
  .filter(empty)
  .join('\n')}

</article>`

const root = document.getElementById('root')
const types = []
const state = {}
const filterElements = () => {
  const onTypes = types.filter(t => state[t] === 'on')
  const offTypes = types.filter(t => state[t] === 'off')
  for (const article of document.getElementsByTagName('article')) {
    if (!offTypes.length && !onTypes.length) {
      article.style.display = ''
      continue
    }

    const show = onTypes.length
      ? onTypes.some(type => article.dataset[type] === 'on')
        && !offTypes.some(type => article.dataset[type] === 'on')
      : offTypes.some(type => article.dataset[type] === 'off')

    article.style.display = show ? '' : 'none'
  }
}

const showTime = () => {

  for (const article of document.getElementsByTagName('article')) {
    if (!offTypes.length && !onTypes.length) {
      article.style.display = ''
      continue
    }

    article.style.display = show ? '' : 'none'
  }
}

const applyButtonState = (button, type, s) => {
  button.className = s
  button.textContent = `${statesIcons[s]}${type}`
  localStorage[type] = s
}

const loadPulls = async (token, userPromise) => {
  const allPr = getList({ name: 'all', owner: '01-edu' }, token)
  const publicPr = getList({ name: 'public', owner: '01-edu' }, token)
  const user = await userPromise
  const pulls = [ ...(await allPr), ...(await publicPr) ]
    .map(pr => ({
      ...pr,
      user,
      updatedAt: new Date(pr.updatedAt),
      to: assign(pr),
    }))
    .sort((a, b) => b.updatedAt - a.updatedAt)
    .map(generateHTML)

  document.body.style.opacity = 1
  const content = pulls.join('')
  localStorage.content = content
  root.innerHTML = content
  filterElements()
}

const statesIcons = { disabled: ' ', on: '+', off: '-' }
for (const button of document.getElementsByTagName('button')) {
  const type = button.textContent.slice(1)
  types.push(type)
  let s = localStorage[type] || 'disabled'
  state[type] = s
  applyButtonState(button, type, s)
  button.addEventListener('click', () => {
    if (s === 'disabled') {
      s = 'on'
    } else if (s === 'on') {
      s = 'off'
    } else {
      s = 'disabled'
    }
    state[type] = s
    filterElements()
    applyButtonState(button, type, s)
    console.log(state)
  })
}

// restore cached state
root.innerHTML = localStorage.content || ''
filterElements()

// fetch fresh state
getToken().then(token => {
  const user = localStorage.user ||
    fetch('https://api.github.com/user', {
      headers: { Authorization: `bearer ${token}` },
      mode: 'cors',
    }).then(async res => (localStorage.user = (await res.json()).login))

  const poller = () => {
    if (document.hidden) return setTimeout(poller, 100)
    loadPulls(token, user).then(() => setTimeout(poller, 5000))
  }

  return poller()
})

</script>
  </body>
</html>
