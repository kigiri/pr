<!DOCTYPE html>
<html>
<head>
  <title></title>
</head>
<body>
<script type="module">
const authUrl = 'https://github.com/login/oauth/authorize'
// const githubUrl = 'https://github.com/login/oauth/access_token' // POST

const rand = () =>
  Math.random()
    .toString(36)
    .slice(2)

const query = `
query ($name: String!, $owner: String!) {

  organization(login: $owner) {
    login
    repository(name: $name) {
      description
      name
    }
  }

  repository(owner: $owner, name: $name) {
    pullRequests(first: 10, states: OPEN) {
      edges {
        node {
          author {
            avatarUrl
            login
          }
          additions
          activeLockReason
          closed
          body
          assignees(first: 10) {
            edges {
              node {
                avatarUrl
                login
              }
            }
          }
        }
      }
    }
  }
}`

const getList = async variables => {
  const res = await fetch('https://api.github.com/graphql', {
   // credentials: 'include',
    headers: {
      accept: '*/*',
      'content-type': 'application/json',
      Authorization: `token ${localStorage.token}`,
    },
    body: JSON.stringify({ query, variables }),
    method: 'POST',
    mode: 'cors',
  })
  return res.json()
}

// getList({ name: 'all', owner: '01-edu' })


const getToken = async () => {
  const { searchParams } = new URL(window.location)
  window.history.replaceState('', '', window.location.pathname)
  const cachedToken = localStorage.token
  if (cachedToken) return cachedToken

  const paramState = searchParams.get('state')
  if (paramState && searchParams.has('code')) {
    if (paramState !== localStorage.state) {
      localStorage.removeItem('state')
      localStorage.removeItem('token')
      return getToken()
    }
    const res = await fetch(`https://pr.kigiri.now.sh/auth?${searchParams}`)
    const body = await res.text()
    const token = new URLSearchParams(body).get('access_token')
    return localStorage.token = token
  }

  const state = [rand(), rand(), rand()].join('-')
  localStorage.state = state

  // Request a user's GitHub identity
  const authorizationUrl = `${authUrl}?${[
    // Required. The client ID you received from GitHub when you registered.
    `client_id=bc9a4b96852fb49c7cb9`,

    // The URL in your application where users will be sent after authorization.
    `redirect_uri=${encodeURIComponent(window.location)}`,

    // A random state
    `state=${state}`,

    // A space-delimited list of scopes.
    `scope=${encodeURIComponent(['user', 'repo'].join(' '))}`,
  ].join('&')}`

  // load the address  
  window.location.replace(authorizationUrl)

  // return an unresolvable promise to pause
  return new Promise(() => {})
}
 
getToken()
  .then(async token => {
    console.log({ token })
    console.log(localStorage.token)
    const { repository } = (await getList({ name: 'all', owner: '01-edu' })).data

    const res = await fetch('https://api.github.com/user', {
     // credentials: 'include',
      headers: {
        accept: '*/*',
        'content-type': 'application/json',
        Authorization: `bearer ${localStorage.token}`,
      },
      mode: 'cors',
    })
    const json = await res.json()
    console.log(repository, json)
  })

</script>
</body>
</html>
